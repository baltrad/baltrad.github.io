<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Distribution</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="customdoxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="BALTRAD-doxlogo.png"></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Frequently Asked Questions and User Guide
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Distribution </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><dl class="section date"><dt>Date</dt><dd>May 2019 </dd></dl>
<dl class="section version"><dt>Version</dt><dd>3.0</dd></dl>
<p>We've installed and configured a BALTRAD node, injected our own data into it, exchanged data with other nodes, generated products with all the data, and even created images for display. Now we want to distribute these products. Here is where we see how.</p>
<p>The node comes equipped with a <em>Distribution route</em>, accessed through the web-based user interface. You can use it to distribute data and/or products using <b>local file copy</b>, <b>FTP</b>, or <b>SCP</b>.</p>
<p>Note that if you use SCP, then you will need valid public and private keys generated by <a href="http://en.wikipedia.org/wiki/Ssh-keygen" target="_blank">ssh-keygen</a> and exchanged with the machine that will receive the distributed files. These keys are not part of the BALTRAD system, they are required to use the safe protocol. There are several pages on the web devoted to explaining how this works, e.g. <a href="https://help.ubuntu.com/community/SSH/OpenSSH/Keys" target="_blank">this one</a> hosted by Ubuntu where you can learn how to set this up.</p>
<p>We will give an example where we distribute the product we've configured and generated in <a class="el" href="pgf.html#pgf_comp">Generating a composite</a> to a remote computer using SCP. In the web-based interface, go to "Processing" --&gt; "Routes" --&gt; "Create
distribution". The first four fields are easy to deal with, while the remaining ones require some attention.</p>
<p>First the "Destination" field which can have one of three different URI formats: </p><ul>
<li>copy:///dir/in/local/system </li>
<li><a href="ftp://user:pass">ftp://user:pass</a>@host/dir/ </li>
<li>scp://user@host/dir/</li>
</ul>
<p>In the example below, we use FTP protocol for file distribution. Destination URI looks like the following:</p>
<pre class="fragment">ftp://rainbow:s3cret@172.31.85.101/opt/baltrad/odimH5/rb5input/BOR
</pre><p>The example URI using SCP would look like this:</p>
<pre class="fragment">scp://rainbow@172.31.85.101/opt/baltrad/odimH5/rb5input/BOR
</pre><dl class="section note"><dt>Note</dt><dd>Directories in the destination must exist, since upload handler doesn't creates target folders. \endnote</dd></dl>
<p>Name template field supports naming the files. If this field is not empty, it will be used to generate the names of the uploaded files. <code>${}</code> is used in the template to specify placeholders. The placeholder itself should be an ODIM_H5 metadata attribute provided with full path. Following is an example of a name template:</p>
<pre class="fragment">${/_bdb/source_name}_${/what/object}_${/what/date}T${/what/time}Z.h5
</pre><p>The template will produce the following file names:</p>
<pre class="fragment">ee_COMP_20120205T010000Z.h5
eehar_PVOL_20120205T010000Z.h5
eesur_PVOL_20120205T010000Z.h5
sease_SCAN_20120206T083200Z.h5
</pre><p>Besides standard ODIM_H5 attributes, the following placeholder variables are triggered with a special prefix <code>/_bdb</code>:</p>
<ul>
<li>/_bdb/uuid - entry uuid </li>
<li>/_bdb/source_name - name of the source in BDB </li>
<li>/_bdb/stored_date - UTC date this file was imported to BDB </li>
<li>/_bdb/stored_time - UTC time this file was imported to BDB</li>
</ul>
<dl class="section note"><dt>Note</dt><dd>Name template takes absolute paths (e.g /what/object). If the name template is not specified, files will be named after the entry UUID. \endnote</dd></dl>
<h1><a class="anchor" id="distr_namer"></a>
Advanced naming functionality</h1>
<p>From version 2.1 of the node software we have started to introduce more advanced features when it comes to creating names in the distribution rules. For one, we have added more complex place holders that can provide names besides the information in the attributes. Secondly we have also added operations that can be applied on the place holder to give ability to modify the presentation.</p>
<h2><a class="anchor" id="distr_namer_datetime"></a>
Formattable date time placeholder</h2>
<p>The first namer we introduced was the possibility to specify your own date and time format from the what/date and what/time attributes. This attribute is defined as</p>
<ul>
<li>${_beast/datetime:&lt;format&gt;} - where the format is the same as used by the SimpleDateTime format in java</li>
</ul>
<p>For example, if you want to specify a date as 2014-12-27 11:12 then you write <b>${_beast/datetime:yyyy-MM-dd HH:mm}</b>.</p>
<p>In some examples you can also use this feature for creating subdirectories, currently this is only available for the copy:/// destination. An example for this would be <b>${_beast/datetime:yyyy/MM/dd/HH/mm}</b>. Hopefully we will be able to support this behaviour for both scp and ftp as well.</p>
<h2><a class="anchor" id="distr_namer_hexcode"></a>
Hex code placeholder for representing quantities</h2>
<p>Since an ODIM H5 file can contain several different quantities it might be interesting to see what quantities that exists in a file by just looking at the filename. For this reason we have created something we call a hexcode namer. The behaviour of this is that you will get a hex code bit mask that defines what quantities that exists in the file.</p>
<p>If for example bit 1 is set for DBZH and bit 2 is set for TH and the file contains both DBZH and TH, then the result of this placeholder would be <b>0x3</b>. The definitions of these fields can be found in odim_quantities.xml which is located in <b>.../third_party/tomcat/webapps/BaltradDex/WEB-INF/classes/odim_quantities.xml</b>. Note, that this file also exists as a duplicate in <b>.../beast/etc/odim_quantities.xml</b> but this file is not used in the node but it gives external applications the possibility to read the same information as is used in the tomcat app server.</p>
<ul>
<li>${_beast/hexcode} - Creates a hex code string that identifies the quantities in a file</li>
</ul>
<h2><a class="anchor" id="distr_namer_suboperations"></a>
Suboperations</h2>
<p>In node version 2.1 we also introduces something that we are calling suboperations. These operations gives the possibility to even more refine the names that the placeholders gives. In some cases you might want to capitalize letters, only extract parts of a name and so on.</p>
<p>The suboperation is applied after the ending '}' for the placeholder, for example. ${what/source:CMT}.tolower().toupper(1) would ensure that only the first letter in the source would be capitalized. As you can see from example it is possible to chain the suboperations. Whenever a suboperation fails they will return the original string. E.g. "xyz".toupper(10) will result in "xyz" instead of null or some sort of exception.</p>
<p>Currently, the following suboperations are supported</p>
<ul>
<li>toupper([beginIndex[,endIndex]) - sets the letters to uppercase. If only beginIndex is specified, it is only for that position. If both begin and end index are specified it applies to that range. If both are missing, then the whole string is changed to upper case.</li>
</ul>
<ul>
<li>tolower([beginIndex[,endIndex]) - same behaviour as for toupper with the difference that the letters are changed to lower case.</li>
</ul>
<ul>
<li>substring(beginIndex,endIndex) - Creates a substring between begin and end index</li>
</ul>
<ul>
<li>substring(endIndex) - Creates a substring from start of string to endIndex. Same as specifying substring(0,endIndex).</li>
</ul>
<ul>
<li>trim() - Trims both left and right side of the string from any white spaces.</li>
</ul>
<ul>
<li>ltrim() - Trims the left side of the string from any white spaces.</li>
</ul>
<ul>
<li>rtrim() - Trims the right side of the string from any white spaces.</li>
</ul>
<h1><a class="anchor" id="distr_filters"></a>
Filter</h1>
<p>The "Filter" is a generic ODIM filtering tool that allows you to define selection criteria based on metadata attributes in ODIM files. In our case we have defined a fairly simple set of two criteria, the <code>/what/source</code> attribute must contain the geographic area name. A full set of idntifiers is used here in order to match files against filter: WMO, RAD, PLC and CMT: </p><pre class="fragment">WMO:06194,RAD:DN44,PLC:Bornholm,CMT:dkbor
</pre><p> This ensures that in case if any of these identifiers match the file's /what/source attribute, the file will be distributed. The second selection criterion is that the <b>/what/object</b> attribute is PVOL, ie. a polar colume. This filtering functionality assumes you are conversant with <a href="http://www.knmi.nl/opera/opera3/OPERA_2008_03_WP2.1b_ODIM_H5_v2.1.pdf" target="_blank">ODIM_H5</a> and its metadata.</p>
<dl class="section note"><dt>Note</dt><dd>Filter takes relative attribute paths (e.g. what/object). \endnote</dd></dl>
<div class="image">
<img src="distr_route.png" alt=""/>
</div>
<h1><a class="anchor" id="distr_scp_route"></a>
Some notes about the SCP distribution rule</h1>
<p>We are using sshj (<a href="https://github.com/hierynomus/sshj/downloads">https://github.com/hierynomus/sshj/downloads</a>) to support file upload with scp and have noticed some things that might cause some head aches when reading the catalina.out log. You might see the following exception over and over again:</p>
<pre class="fragment">21 Dec 2014 14:18:05 WARN  net.schmizz.sshj.SSHClient - Could not load keys due to: {}
java.io.FileNotFoundException: /home/baltrad/.ssh/id_dsa (No such file or directory)
        at java.io.FileInputStream.open(Native Method)
        at java.io.FileInputStream.&lt;init&gt;(FileInputStream.java:138)
        at java.io.FileReader.&lt;init&gt;(FileReader.java:72)
        at net.schmizz.sshj.userauth.keyprovider.KeyProviderUtil.detectKeyFileFormat(KeyProviderUtil.java:40)
        at net.schmizz.sshj.SSHClient.loadKeys(SSHClient.java:478)
</pre><p>This is really not any problem, it is just the SSHJ library saying that it couldn't find the .ssh/id_dsa file but it will keep on handling the file upload anyway. If you want to get rid of the exception from the log, you will just have to create the id_dsa file by typing:</p>
<pre class="fragment">%&gt; ssh-keygen -t dsa
</pre><p>and follow the instructions. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->

<hr class="footer"/><address class="footer"><small>
</a><a href="mailto:support@baltrad.eu">support@baltrad.eu</a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Generated on Fri Oct 1 2021 09:06:25 by&#160;<a href="http://www.doxygen.org/index.html"><img class="footer" src="doxygen.png" alt="doxygen"/> 1.9.1 for <a href="http://baltrad.eu/" target="_blank"><img class="footer" src="foot_BALTRAD-doxlogo.png" /></a></small></address>
</body>
</html>
